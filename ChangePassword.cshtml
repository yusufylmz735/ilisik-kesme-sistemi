@model HayataAtilmaFormu.Models.ViewModels.ChangePasswordViewModel
@{
    ViewData["Title"] = "Şifre Değiştir";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="page-title">
                <i class="fas fa-key me-2"></i>Şifre Değiştir
            </h2>
            <a href="@Url.Action("Index", "Profile")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Profile Dön
            </a>
        </div>

        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Güvenlik Ayarları
                </h5>
            </div>
            <div class="card-body p-4">
                @if (!string.IsNullOrEmpty(ViewBag.Error))
                {
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        @ViewBag.Error
                    </div>
                }

                @if (!string.IsNullOrEmpty(ViewBag.Success))
                {
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        @ViewBag.Success
                    </div>
                }

                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-info-circle fa-2x text-info me-3 mt-1"></i>
                                <div>
                                    <h6 class="alert-heading">Güvenlik Uyarısı</h6>
                                    <ul class="mb-0 small">
                                        <li>Mevcut şifrenizi doğru girdiğinizden emin olun</li>
                                        <li>Yeni şifreniz en az 6 karakter olmalıdır</li>
                                        <li>Güçlü bir şifre için büyük/küçük harf, rakam ve özel karakter kullanın</li>
                                        <li>Şifrenizi başkalarıyla paylaşmayın</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <form method="post">
                    @Html.AntiForgeryToken()

                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-4">
                                <label for="CurrentPassword" class="form-label fw-bold">
                                    <i class="fas fa-lock me-2"></i>Mevcut Şifre
                                </label>
                                <div class="input-group">
                                    <input type="password"
                                           class="form-control form-control-lg"
                                           id="CurrentPassword"
                                           name="CurrentPassword"
                                           placeholder="Mevcut şifrenizi girin"
                                           required />
                                    <button class="btn btn-outline-secondary"
                                            type="button"
                                            onclick="togglePassword('CurrentPassword', 'toggleIcon1')">
                                        <i class="fas fa-eye" id="toggleIcon1"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    Güvenlik için mevcut şifrenizi onaylamanız gerekiyor
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="NewPassword" class="form-label fw-bold">
                                    <i class="fas fa-key me-2"></i>Yeni Şifre
                                </label>
                                <div class="input-group">
                                    <input type="password"
                                           class="form-control form-control-lg"
                                           id="NewPassword"
                                           name="NewPassword"
                                           placeholder="Yeni şifrenizi girin"
                                           minlength="6"
                                           required />
                                    <button class="btn btn-outline-secondary"
                                            type="button"
                                            onclick="togglePassword('NewPassword', 'toggleIcon2')">
                                        <i class="fas fa-eye" id="toggleIcon2"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Şifre Güvenlik Göstergesi -->
                            <div class="mb-4">
                                <label class="form-label small fw-bold">Şifre Güvenliği</label>
                                <div class="progress" style="height: 8px;">
                                    <div id="passwordStrength" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small id="strengthText" class="form-text"></small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ConfirmPassword" class="form-label fw-bold">
                                    <i class="fas fa-key me-2"></i>Şifre Tekrarı
                                </label>
                                <div class="input-group">
                                    <input type="password"
                                           class="form-control form-control-lg"
                                           id="ConfirmPassword"
                                           name="ConfirmPassword"
                                           placeholder="Yeni şifrenizi tekrar girin"
                                           minlength="6"
                                           required />
                                    <button class="btn btn-outline-secondary"
                                            type="button"
                                            onclick="togglePassword('ConfirmPassword', 'toggleIcon3')">
                                        <i class="fas fa-eye" id="toggleIcon3"></i>
                                    </button>
                                </div>
                                <div id="passwordMatch" class="form-text"></div>
                            </div>

                            <!-- Şifre Kuralları -->
                            <div class="mt-4">
                                <label class="form-label small fw-bold">Şifre Kuralları</label>
                                <ul class="list-unstyled small">
                                    <li id="rule-length" class="text-muted">
                                        <i class="fas fa-circle me-2" style="font-size: 0.5rem;"></i>
                                        En az 6 karakter
                                    </li>
                                    <li id="rule-lowercase" class="text-muted">
                                        <i class="fas fa-circle me-2" style="font-size: 0.5rem;"></i>
                                        Küçük harf (a-z)
                                    </li>
                                    <li id="rule-uppercase" class="text-muted">
                                        <i class="fas fa-circle me-2" style="font-size: 0.5rem;"></i>
                                        Büyük harf (A-Z)
                                    </li>
                                    <li id="rule-number" class="text-muted">
                                        <i class="fas fa-circle me-2" style="font-size: 0.5rem;"></i>
                                        Rakam (0-9)
                                    </li>
                                    <li id="rule-special" class="text-muted">
                                        <i class="fas fa-circle me-2" style="font-size: 0.5rem;"></i>
                                        Özel karakter (!#$%^&*)
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted">
                            <small>
                                <i class="fas fa-clock me-1"></i>
                                Son şifre değiştirme: 
                                <span class="fw-bold">Bilinmiyor</span>
                            </small>
                        </div>
                        <div>
                            <a href="@Url.Action("Index", "Profile")" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-times me-1"></i>İptal
                            </a>
                            <button type="submit" class="btn btn-warning btn-lg">
                                <i class="fas fa-save me-2"></i>Şifreyi Değiştir
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Ek Güvenlik Önerileri -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Güvenlik Önerileri
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success">
                            <i class="fas fa-check me-2"></i>Yapılması Gerekenler
                        </h6>
                        <ul class="small text-muted">
                            <li>Düzenli şifre değiştirin (3-6 ayda bir)</li>
                            <li>Her hesap için farklı şifre kullanın</li>
                            <li>İki faktörlü kimlik doğrulama kullanın</li>
                            <li>Şifrelerinizi güvenli yerlerde saklayın</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-danger">
                            <i class="fas fa-times me-2"></i>Yapılmaması Gerekenler
                        </h6>
                        <ul class="small text-muted">
                            <li>Kişisel bilgilerinizi şifrede kullanmayın</li>
                            <li>Şifrelerinizi başkalarıyla paylaşmayın</li>
                            <li>Halka açık bilgisayarlarda şifreyi kaydetmeyin</li>
                            <li>Basit ve tahmin edilebilir şifreler seçmeyin</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function togglePassword(inputId, iconId) {
            const passwordInput = document.getElementById(inputId);
            const toggleIcon = document.getElementById(iconId);

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        function checkPasswordStrength(password) {
            let strength = 0;
            let strengthText = '';
            let strengthClass = '';

            // Kuralları kontrol et
            const rules = {
                length: password.length >= 6,
                lowercase: /[a-z]/.test(password),
                uppercase: /[A-Z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[^A-Za-z0-9]/.test(password)
            };

            // Kuralları görsel olarak güncelle
            Object.keys(rules).forEach(rule => {
                const element = document.getElementById('rule-' + rule);
                if (rules[rule]) {
                    element.className = 'text-success';
                    element.querySelector('i').className = 'fas fa-check-circle me-2';
                    strength += 20;
                } else {
                    element.className = 'text-muted';
                    element.querySelector('i').className = 'fas fa-circle me-2';
                    element.querySelector('i').style.fontSize = '0.5rem';
                }
            });

            // Güçlülük seviyesi belirle
            if (strength < 40) {
                strengthText = 'Çok Zayıf';
                strengthClass = 'bg-danger';
            } else if (strength < 60) {
                strengthText = 'Zayıf';
                strengthClass = 'bg-warning';
            } else if (strength < 80) {
                strengthText = 'Orta';
                strengthClass = 'bg-info';
            } else {
                strengthText = 'Güçlü';
                strengthClass = 'bg-success';
            }

            // Progress bar güncelle
            document.getElementById('passwordStrength').style.width = strength + '%';
            document.getElementById('passwordStrength').className = 'progress-bar ' + strengthClass;
            document.getElementById('strengthText').textContent = strengthText;
        }

        function checkPasswordMatch() {
            const password = document.getElementById('NewPassword').value;
            const confirmPassword = document.getElementById('ConfirmPassword').value;
            const matchDiv = document.getElementById('passwordMatch');

            if (confirmPassword.length > 0) {
                if (password === confirmPassword) {
                    matchDiv.textContent = 'Şifreler eşleşiyor ✓';
                    matchDiv.className = 'form-text text-success';
                } else {
                    matchDiv.textContent = 'Şifreler eşleşmiyor ✗';
                    matchDiv.className = 'form-text text-danger';
                }
            } else {
                matchDiv.textContent = '';
                matchDiv.className = 'form-text';
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const newPasswordInput = document.getElementById('NewPassword');
            const confirmPasswordInput = document.getElementById('ConfirmPassword');

            newPasswordInput.addEventListener('input', function() {
                checkPasswordStrength(this.value);
                if (confirmPasswordInput.value) {
                    checkPasswordMatch();
                }
            });

            confirmPasswordInput.addEventListener('input', checkPasswordMatch);

            // Form submission
            document.querySelector('form').addEventListener('submit', function(e) {
                const currentPassword = document.getElementById('CurrentPassword').value;
                const newPassword = document.getElementById('NewPassword').value;
                const confirmPassword = document.getElementById('ConfirmPassword').value;

                // Validasyonlar
                if (!currentPassword) {
                    e.preventDefault();
                    alert('Mevcut şifrenizi girmelisiniz.');
                    return false;
                }

                if (newPassword.length < 6) {
                    e.preventDefault();
                    alert('Yeni şifre en az 6 karakter olmalıdır.');
                    return false;
                }

                if (newPassword !== confirmPassword) {
                    e.preventDefault();
                    alert('Yeni şifreler eşleşmiyor. Lütfen kontrol edin.');
                    return false;
                }

                if (currentPassword === newPassword) {
                    e.preventDefault();
                    alert('Yeni şifre mevcut şifre ile aynı olamaz.');
                    return false;
                }

                // Loading state
                const submitBtn = document.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Değiştiriliyor...';
                submitBtn.disabled = true;
            });

            // Caps Lock uyarısı
            const passwordInputs = document.querySelectorAll('input[type="password"]');
            passwordInputs.forEach(input => {
                input.addEventListener('keydown', function(e) {
                    if (e.getModifierState && e.getModifierState('CapsLock')) {
                        if (!document.getElementById('capsLockWarning')) {
                            const warning = document.createElement('div');
                            warning.id = 'capsLockWarning';
                            warning.className = 'alert alert-warning alert-dismissible fade show mt-2';
                            warning.innerHTML = `
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Caps Lock açık! Şifre girişi sırasında dikkat edin.
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                            input.parentNode.parentNode.appendChild(warning);
                        }
                    }
                });
            });
        });
    </script>
}

<style>
    .input-group .form-control {
        border-right: 0;
    }
    
    .input-group .btn-outline-secondary {
        border-left: 0;
        border-color: #ced4da;
    }
    
    .progress {
        border-radius: 10px;
        background-color: #e9ecef;
    }
    
    .progress-bar {
        border-radius: 10px;
        transition: width 0.3s ease, background-color 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #ffc107;
        box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
    }
    
    .btn-warning:focus {
        box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.5);
    }
    
    .list-unstyled li {
        padding: 2px 0;
        transition: color 0.3s ease;
    }
</style>